worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout 65;

    # 定義日誌格式，加入了 $upstream_addr 方便追蹤
    log_format upstream_log '$remote_addr - $remote_user [$time_local] '
                            '"$request" $status $body_bytes_sent '
                            '"$http_referer" "$http_user_agent" '
                            'upstream: $upstream_addr request_time: $request_time';

    access_log /dev/stdout upstream_log;
    error_log  /dev/stderr warn;

    # WebSocket 升級判斷
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # 後端服務池 (使用 api_upstream 以保持一致性)
    upstream api_upstream {
        # ip_hash 確保同一個用戶的請求發送到同一個後端，利於 Session 維護
        # ip_hash; 
        # server backend:3000;
        # server backend2:3001;


        # 改用backend replicas=2
        hash $cookie_chatroom.sid consistent;
        server backend:3000;

        # 改成docker後，大家的進入點都是透過vm 無法再用ip區分
        #server backend:3000 weight=5;
        #server backend2:3001 weight=5;
    }

    server {
        listen 8080;

        root   /usr/share/nginx/html;
        index  index.html;


        location /nginx_status {
            stub_status;
            allow 0.0.0.0/0;
            # deny all;

        }
        location / {
            try_files $uri  /index.html;
        }



        location /api/message/ {

            proxy_pass http://api_upstream;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
        }

        location /api/webhook/ {

            proxy_pass http://api_upstream;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
        }



        # 核心修正區塊：強制代理所有 /api/ 請求
        location ~ ^/(login|logout|check-session|register|history) {
            
            # 確保 POST, GET, HEAD 等方法都能進入代理邏輯
            # 雖然 proxy_pass 應涵蓋所有方法，但這能確保 Nginx 不會因方法而阻擋
            
            proxy_pass http://api_upstream; 
            
            # 確保使用 HTTP 1.1 協議
            proxy_http_version 1.1; 
            
            # 移除 Connection 標頭，防止在代理時出錯
            proxy_set_header Connection ""; 
            
            # 標準代理標頭設定
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # 保持 Cookie 傳遞
            proxy_set_header Cookie $http_cookie;
            proxy_pass_header Set-Cookie;
        }




        # Socket.IO 區塊... (保持不變)
        location /socket.io/ {
            proxy_pass http://api_upstream;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Cookie $http_cookie;
            proxy_read_timeout 7d;
            proxy_send_timeout 7d;
        }

        # SPA 靜態資源及路由處理 (保持不變)
        
    }
}